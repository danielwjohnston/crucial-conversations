<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leadership Bookclub - What's a Crucial Conversation</title>
    <link rel="stylesheet" href="shared.css">
    <link rel="prefetch" href="chapter_02_mastering_conversations.html">
</head>
<body>
    <a class="skip-link" href="#main-content">Skip to content</a>

    <header class="header" role="banner">
        <span class="header-brand">CrucialLearning.com | 800.449.5989</span>
        <span class="header-slide-counter" id="slideCounter">
            <span id="slideNumber">1</span> / <span id="totalSlides">14</span>
        </span>
    </header>

    <footer class="footer" role="contentinfo">
        ©2026 Leadership Development. All rights reserved.
    </footer>

    <main id="main-content" class="slideshow-container" aria-label="Slideshow presentation">
        <div id="timerAria" class="sr-only" aria-live="polite" aria-atomic="true"></div>

        <div class="persistent-header" id="chapterHeader">
            <div class="persistent-header-left">
                <span class="persistent-header-title" id="headerTitle">Ch. 1: WHAT'S A CRUCIAL CONVERSATION</span>
                <span class="persistent-header-subtitle" id="headerSubtitle">And who cares?</span>
            </div>
            <div class="chapter-dropdown-wrapper">
                <button class="chapter-dropdown-btn" id="dropdownBtn" aria-expanded="false" aria-haspopup="true">
                    Chapters <span class="arrow">▼</span>
                </button>
                <div class="chapter-dropdown-menu" id="dropdownMenu" role="menu">
                </div>
            </div>
        </div>

        <div class="slide active title-slide">
            <div class="brand-logo">Leadership Bookclub</div>
            <h1>CHAPTER 1</h1>
            <h2>What's a Crucial Conversation?</h2>
            <p class="subtitle">And who cares?</p>
            <div class="quote-box" style="margin-top: 25px;">
                <p style="font-size: 1.25em; text-align: center; margin-bottom: 14px;">"The single biggest problem in communication is the illusion that it has taken place."</p>
                <p style="text-align: center; font-size: 1.05em;">— George Bernard Shaw</p>
            </div>
        </div>

        <div class="slide">
            <div class="slide-content">
                <h2>What Comes to Mind?</h2>
                <p>When you hear “crucial conversation,” what images appear?</p>
                <ul>
                    <li>Presidents and prime ministers</li>
                    <li>Massive tables and debates</li>
                    <li>High-stakes decisions</li>
                    <li>The future of nations</li>
                </ul>
                <div class="highlight">
                    <p class="key-point">Crucial conversations happen to everyone—every day.</p>
                </div>
            </div>
        </div>

        <div class="slide">
            <div class="slide-content">
                <h2>The Definition</h2>
                <div class="bridge-box">
                    <h3 style="text-align:center; margin-bottom: 15px;">A conversation becomes <em>crucial</em> when:</h3>
                    <ul style="font-size: 1.2em;">
                        <li><strong>Opinions vary</strong></li>
                        <li><strong>Stakes are high</strong></li>
                        <li><strong>Emotions run strong</strong></li>
                    </ul>
                </div>
                <p style="margin-top: 20px;">When all three are present, the risk of breakdown rises—so does the payoff for doing it well.</p>
            </div>
        </div>

        <div class="slide">
            <div class="slide-content">
                <h2>Everyday Examples</h2>
                <div class="two-column">
                    <div class="column-box">
                        <h4>At Work</h4>
                        <ul>
                            <li><strong>Promotion:</strong> You think you’re ready. Your boss thinks you’re not.</li>
                            <li><strong>Strategy meeting:</strong> Pick a new marketing approach—or the company suffers.</li>
                            <li><strong>Performance:</strong> A teammate’s work is hurting results and trust.</li>
                        </ul>
                    </div>
                    <div class="column-box">
                        <h4>At Home</h4>
                        <ul>
                            <li><strong>Trust:</strong> Your spouse believes you flirted at a party. You don’t.</li>
                            <li><strong>Neighbors:</strong> A small complaint escalates into a heated argument.</li>
                            <li><strong>Parenting:</strong> Two people who love the child disagree on what’s best.</li>
                        </ul>
                    </div>
                </div>
                <div class="highlight" style="margin-top: 20px;">
                    <p class="key-point">These conversations reshape your life now.</p>
                </div>
            </div>
        </div>

        <div class="slide">
            <div class="slide-content">
                <h2>Why We’re Often on Our Worst Behavior</h2>
                <div class="warning-box">
                    <h3>The cruel irony</h3>
                    <p>The more important the conversation, the less likely we are to handle it well.</p>
                    <ul style="margin-top: 15px;">
                        <li><strong>Fight-or-flight</strong> hijacks thinking</li>
                        <li><strong>Stories</strong> escalate emotion</li>
                        <li><strong>Silence or violence</strong> replace dialogue</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="slide">
            <div class="slide-content">
                <h2>Lag Time</h2>
                <div class="highlight">
                    <h3>Lag time = the delay between a problem and an honest conversation about it</h3>
                    <p style="margin-top: 10px;">The damage often comes from what happens <em>during the delay</em>—assumptions, resentment, and workarounds.</p>
                </div>
                <div class="exercise">
                    <h3>Quick reflection</h3>
                    <p>Where do you see lag time in your work or relationships right now?</p>
                </div>
            </div>
        </div>

        <div class="slide">
            <div class="slide-content">
                <h2>What Is Dialogue?</h2>
                <div class="definition">
                    <h3>Dialogue is the free flow of meaning between two or more people.</h3>
                    <p style="margin-top: 10px;">The goal isn’t to “win”—it’s to create enough shared meaning to make better choices.</p>
                </div>
            </div>
        </div>

        <div class="slide">
            <div class="slide-content">
                <h2>The Pool of Shared Meaning</h2>
                <div class="bridge-box">
                    <ul>
                        <li>When the pool gets bigger, people see more options.</li>
                        <li>Better options lead to better decisions.</li>
                        <li>Dialogue motivates and enables better choices.</li>
                    </ul>
                </div>
                <p style="margin-top: 20px;"><strong>Book club goal:</strong> Practice growing the pool—not shrinking it.</p>
            </div>
        </div>

        <div class="slide discussion-slide">
            <div class="slide-content">
                <h2>Discussion Break #1</h2>
                <div class="discussion-question">
                    <p>Think of a conversation you've been putting off. What makes it crucial—is it the differing opinions, the high stakes, or the strong emotions? And when the pressure rises, what's your default: do you go quiet or get forceful, and what does that cost you?</p>
                </div>
                <button class="digest-pill" type="button" data-digest="1" onclick="openDigest(1)" aria-haspopup="dialog" aria-controls="digestModal1">
                    <span class="dot" aria-hidden="true"></span>
                    Dan’s Digest
                </button>
            </div>
        </div>

        <div class="slide">
            <div class="slide-content">
                <h2>Apply It This Week</h2>
                <div class="step-box">
                    <h4>Step 1</h4>
                    <p>Pick one conversation you’ve been delaying (lag time).</p>
                </div>
                <div class="step-box">
                    <h4>Step 2</h4>
                    <p>Name the three elements: opinions, stakes, emotions.</p>
                </div>
                <div class="step-box">
                    <h4>Step 3</h4>
                    <p>Define success as “grow the pool,” not “win the point.”</p>
                </div>
            </div>
        </div>

        <div class="slide discussion-slide">
            <div class="slide-content">
                <h2>Discussion Break #2</h2>
                <div class="discussion-question">
                    <p>Where do you see lag time showing up in your life right now, and what is it costing you? If the goal of dialogue is to "grow the pool of shared meaning," what would it look like to take even a small step toward that conversation this week?</p>
                </div>
                <button class="digest-pill" type="button" data-digest="2" onclick="openDigest(2)" aria-haspopup="dialog" aria-controls="digestModal2">
                    <span class="dot" aria-hidden="true"></span>
                    Dan’s Digest
                </button>
            </div>
        </div>

        <div class="slide">
            <div class="slide-content">
                <h2>This Week’s Challenge</h2>
                <div class="highlight">
                    <h3>Pick one conversation you’ve been delaying</h3>
                    <ul>
                        <li>Name the three elements (opinions, stakes, emotions)</li>
                        <li>Define success as “grow the pool”</li>
                        <li>Schedule a first step (even a 10-minute start)</li>
                    </ul>
                </div>
                <div class="quote-box" style="margin-top: 25px;">
                    <p style="text-align:center;"><strong>Key takeaway:</strong> Better outcomes come from better pools of shared meaning.</p>
                </div>
                <p style="margin-top: 18px;"><strong>Next meeting:</strong> Bring one example where you noticed opinions/stakes/emotions early—and what you did differently.</p>
            </div>
        </div>

        <div class="slide">
            <div class="slide-content">
                <h2>More to Ponder</h2>
                <p class="subtitle">Use these as a quick review of key takeaways and ideas to keep thinking about.</p>
                <div class="story-box">
                    <h3>Choose 1–2 prompts</h3>
                    <ul>
                        <li>What are the three elements that make a conversation crucial?</li>
                        <li>How do you typically respond under pressure—silence, violence, or dialogue?</li>
                        <li>Where is lag time showing up for you, and what is it costing you?</li>
                        <li>What does it look like to “grow the pool” in a real conversation this week?</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="slide look-ahead-slide">
            <div class="slide-content">
                <h1>Look Ahead</h1>
                <h2>Chapter 2: Mastering Conversations</h2>
                <div class="highlight" style="margin-top: 10px;">
                    <h3>What we’ll focus on next</h3>
                    <ul>
                        <li><strong>Why</strong> it’s hard to choose the right topic when emotions rise</li>
                        <li>How to avoid the trap of having the <strong>wrong conversation</strong></li>
                        <li>A simple way to decide what to talk about when things get messy</li>
                    </ul>
                </div>
                <p class="subtitle" style="margin-top: 18px;"><strong>Optional prep:</strong> Bring one situation where the conversation keeps drifting or looping.</p>
            </div>
        </div>

</main>

    <nav class="navigation" role="navigation" aria-label="Slide navigation">
        <button class="nav-btn" onclick="previousSlide()" aria-label="Previous slide">← Back</button>
        <div class="timer-container" id="timerContainer">
            <div class="circular-timer">
                <svg width="60" height="60">
                    <circle class="timer-background" cx="30" cy="30" r="26"/>
                    <circle class="timer-progress" id="timerCircle" cx="30" cy="30" r="26"/>
                </svg>
                <div class="timer-text" id="timerText">0:00</div>
            </div>
        </div>
        <button class="auto-advance-toggle" onclick="toggleAutoAdvance()" aria-pressed="false">
            <span aria-hidden="true">▶</span> Auto-Advance: OFF
        </button>
        <button class="nav-btn" onclick="nextSlide()" aria-label="Next slide">Next →</button>
    </nav>

    <div class="digest-modal" id="digestModal1" role="dialog" aria-labelledby="digestTitle1" aria-modal="true">
        <div class="digest-content">
            <button class="digest-close" onclick="closeDigest(1)" aria-label="Close">&times;</button>
            <h2 id="digestTitle1">Dan’s Digest</h2>
            <div class="digest-answer">
                <h4>Answer Key (Discussion Break #1)</h4>
                <p><strong>What makes it crucial:</strong> When <strong>opinions vary</strong>, <strong>stakes are high</strong>, and <strong>emotions run strong</strong>.</p>
                <p style="margin-top: 12px;"><strong>Plain vanilla vs. crucial:</strong> The topic may be ordinary, but when disagreement matters, consequences feel big, and emotions show up, the conversation becomes crucial.</p>
                <p style="margin-top: 12px;"><strong>Typical default reactions:</strong> People tend to move toward <strong>silence</strong> (avoid, withdraw, sugarcoat) or <strong>violence</strong> (control, pressure, attack). Either one shrinks shared meaning.</p>
            </div>
            <div class="digest-insights">
                <h4>Key Points</h4>
                <ul>
                    <li>The goal isn’t to win—it’s to keep dialogue going.</li>
                    <li>When someone feels unsafe, they stop contributing meaning.</li>
                    <li>Better outcomes come from a bigger Pool of Shared Meaning.</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="digest-modal" id="digestModal2" role="dialog" aria-labelledby="digestTitle2" aria-modal="true">
        <div class="digest-content">
            <button class="digest-close" onclick="closeDigest(2)" aria-label="Close">&times;</button>
            <h2 id="digestTitle2">Dan’s Digest</h2>
            <div class="digest-answer">
                <h4>Answer Key (Discussion Break #2)</h4>
                <p><strong>Why we’re often on our worst behavior:</strong> Under stress we revert to fight-or-flight. We tell ourselves fast stories, emotions spike, and we choose silence or violence instead of dialogue.</p>
                <p style="margin-top: 12px;"><strong>Lag time:</strong> The delay between a problem and the conversation about it. During the delay, we build stories, resentment, and workarounds—making the eventual conversation harder and riskier.</p>
                <p style="margin-top: 12px;"><strong>Dialogue & the Pool:</strong> Dialogue is the free flow of meaning. The Pool of Shared Meaning is what everyone knows, believes, and feels that’s been shared. A bigger pool creates better choices and stronger commitment—even without full agreement.</p>
            </div>
            <div class="digest-insights">
                <h4>Key Points</h4>
                <ul>
                    <li>Skill isn’t just talking—it’s keeping conditions safe enough for meaning to flow.</li>
                    <li>Shorten lag time to prevent stories from calcifying into certainty.</li>
                    <li>Shared meaning expands options; options improve decisions and follow-through.</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // ============================================================
        // CHAPTER DATA — single source of truth
        // ============================================================
        const CHAPTERS = [
            { num: 1,  file: "chapter_01_crucial_conversation.html",  title: "What\u2019s a Crucial Conversation", subtitle: "And who cares?", part: 1 },
            { num: 2,  file: "chapter_02_mastering_conversations.html", title: "Mastering Crucial Conversations", subtitle: "The power of dialogue", part: 1 },
            { num: 3,  file: "chapter_03_choose_topic.html",          title: "Choose Your Topic", subtitle: "How to be sure you hold the right conversation", part: 1 },
            { num: 4,  file: "chapter_04_start_heart.html",           title: "Start with Heart", subtitle: "How to stay focused on what you really want", part: 1 },
            { num: 5,  file: "chapter_05_master_stories.html",        title: "Master My Stories", subtitle: "How to stay in dialogue when you\u2019re angry, scared, or hurt", part: 2 },
            { num: 6,  file: "chapter_06_learn_to_look.html",         title: "Learn to Look", subtitle: "How to notice when safety is at risk", part: 2 },
            { num: 7,  file: "chapter_07_make_safe.html",             title: "Make It Safe", subtitle: "How to make it safe to talk about almost anything", part: 2 },
            { num: 8,  file: "chapter_08_state_path.html",            title: "STATE My Path", subtitle: "How to speak persuasively, not abrasively", part: 2 },
            { num: 9,  file: "chapter_09_explore_paths.html",         title: "Explore Others\u2019 Paths", subtitle: "How to listen when others blow up or clam up", part: 2 },
            { num: 10, file: "chapter_10_retake_pen.html",            title: "Retake Your Pen", subtitle: "How to be resilient and hear almost anything", part: 2 },
            { num: 11, file: "chapter_11_move_action.html",           title: "Move to Action", subtitle: "How to turn crucial conversations into action and results", part: 3 },
            { num: 12, file: "chapter_12_yeah_but.html",              title: "Yeah, But", subtitle: "Advice for tough cases", part: 3 },
            { num: 13, file: "chapter_13_putting_together.html",      title: "Putting It All Together", subtitle: "Tools for preparing and learning", part: 3 },
        ];

        const PART_LABELS = {
            1: "Part I \u2014 Before You Open Your Mouth",
            2: "Part II \u2014 How to Open Your Mouth",
            3: "Part III \u2014 How to Finish"
        };

        const CURRENT_CHAPTER_INDEX = 0; // Chapter 1

        let currentSlide = 0;
        const slides = document.querySelectorAll('.slide');
        const totalSlides = slides.length;
        const chapterHeader = document.getElementById('chapterHeader');
        const timerContainer = document.getElementById('timerContainer');
        const timerText = document.getElementById('timerText');
        const timerCircle = document.getElementById('timerCircle');
        const autoAdvanceToggle = document.querySelector('.auto-advance-toggle');
        const timerAria = document.getElementById('timerAria');
        
        let autoAdvanceEnabled = false;
        let countdownInterval = null;
        let remainingTime = 0;
        let totalDuration = 0;
        let lastAnnouncement = -1;
        
        document.getElementById('totalSlides').textContent = totalSlides;
        
        // Timings for Chapter 1 (in seconds) — ~60 minutes total
        const DURATIONS_SECONDS = [
            45,   // 1 Title
            180,  // 2 What Comes to Mind
            180,  // 3 Definition
            240,  // 4 Everyday Examples
            240,  // 5 Worst Behavior
            240,  // 6 Lag Time
            240,  // 7 What Is Dialogue
            240,  // 8 Pool of Shared Meaning
            540,  // 9 Discussion Break #1
            300,  // 10 Apply It This Week
            840,  // 11 Discussion Break #2
            240,  // 12 This Week's Challenge
            240,  // 13 More to Ponder
            90,   // 14 Look Ahead
        ];

        function openDigest(n) {
            const modal = document.getElementById(`digestModal${n}`);
            if (!modal) return;
            modal.classList.add('active');
            const closeBtn = modal.querySelector('.digest-close');
            if (closeBtn) closeBtn.focus();
        }

        function closeDigest(n) {
            const modal = document.getElementById(`digestModal${n}`);
            if (!modal) return;
            modal.classList.remove('active');
        }

        function closeAllDigests() {
            document.querySelectorAll('.digest-modal.active').forEach((modal) => modal.classList.remove('active'));
        }

        document.querySelectorAll('.digest-modal').forEach((modal) => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });

        // ============================================================
        // CHAPTER DROPDOWN
        // ============================================================
        function buildDropdown() {
            const menu = document.getElementById('dropdownMenu');
            menu.innerHTML = '';
            let currentPart = 0;

            CHAPTERS.forEach((ch, idx) => {
                if (ch.part !== currentPart) {
                    currentPart = ch.part;
                    if (idx > 0) {
                        const divider = document.createElement('div');
                        divider.className = 'dropdown-divider';
                        menu.appendChild(divider);
                    }
                    const label = document.createElement('div');
                    label.className = 'dropdown-section-label';
                    label.textContent = PART_LABELS[currentPart];
                    menu.appendChild(label);
                }

                const item = document.createElement('div');
                item.className = 'chapter-dropdown-item' + (idx === CURRENT_CHAPTER_INDEX ? ' active' : '');
                item.setAttribute('role', 'menuitem');
                item.setAttribute('tabindex', '0');
                item.innerHTML = `
                    <span class="ch-num">${ch.num}</span>
                    <span class="ch-info">
                        <span class="ch-title">${ch.title}</span>
                        <span class="ch-subtitle">${ch.subtitle}</span>
                    </span>
                `;
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    closeDropdown();
                    if (idx !== CURRENT_CHAPTER_INDEX) {
                        window.location.href = ch.file;
                    }
                });
                item.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        closeDropdown();
                        if (idx !== CURRENT_CHAPTER_INDEX) {
                            window.location.href = ch.file;
                        }
                    }
                });
                menu.appendChild(item);
            });

            // "Back to Chapter Select" option
            const divider = document.createElement('div');
            divider.className = 'dropdown-divider';
            menu.appendChild(divider);
            const backItem = document.createElement('div');
            backItem.className = 'chapter-dropdown-item';
            backItem.setAttribute('role', 'menuitem');
            backItem.setAttribute('tabindex', '0');
            backItem.innerHTML = `
                <span class="ch-num" style="background:#333;color:white;border-color:#333;">☰</span>
                <span class="ch-info"><span class="ch-title">Back to Chapter Select</span></span>
            `;
            backItem.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); window.location.href = '../index.html'; });
            backItem.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); window.location.href = '../index.html'; } });
            menu.appendChild(backItem);
        }

        const dropdownBtn = document.getElementById('dropdownBtn');
        const dropdownMenu = document.getElementById('dropdownMenu');

        function toggleDropdown() {
            const isOpen = dropdownMenu.classList.contains('open');
            if (isOpen) closeDropdown(); else openDropdown();
        }

        function openDropdown() {
            dropdownMenu.classList.add('open');
            dropdownBtn.classList.add('open');
            dropdownBtn.setAttribute('aria-expanded', 'true');
        }

        function closeDropdown() {
            dropdownMenu.classList.remove('open');
            dropdownBtn.classList.remove('open');
            dropdownBtn.setAttribute('aria-expanded', 'false');
        }

        dropdownBtn.addEventListener('click', toggleDropdown);

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.chapter-dropdown-wrapper')) closeDropdown();
        });

        // ============================================================
        // CROSS-CHAPTER NAVIGATION
        // ============================================================
        function goToNextChapter() {
            if (CURRENT_CHAPTER_INDEX < CHAPTERS.length - 1) {
                window.location.href = CHAPTERS[CURRENT_CHAPTER_INDEX + 1].file;
            }
        }

        function goToPrevChapter() {
            if (CURRENT_CHAPTER_INDEX > 0) {
                window.location.href = CHAPTERS[CURRENT_CHAPTER_INDEX - 1].file + '?slide=last';
            } else {
                window.location.href = '../index.html';
            }
        }

        function updateChapterNavButtons() {
            const prevBtn = document.getElementById('prevChapterBtn');
            const nextBtn = document.getElementById('nextChapterBtn');
            if (prevBtn) prevBtn.disabled = CURRENT_CHAPTER_INDEX === 0;
            if (nextBtn) nextBtn.disabled = CURRENT_CHAPTER_INDEX === CHAPTERS.length - 1;
        }

        function getSlideDuration() {
            return DURATIONS_SECONDS[currentSlide] ?? 60;
        }
        
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        function updateTimerCircle() {
            const circumference = 163.36;
            const progress = remainingTime / totalDuration;
            const offset = circumference * (1 - progress);
            timerCircle.style.strokeDashoffset = offset;
        }
        
        function announceTimer(msg) {
            if (timerAria) {
                timerAria.textContent = msg;
            }
        }
        
        function startTimer() {
            if (!autoAdvanceEnabled) return;
            
            stopTimer();
            
            totalDuration = getSlideDuration();
            remainingTime = totalDuration;
            lastAnnouncement = -1;
            
            timerText.textContent = formatTime(remainingTime);
            updateTimerCircle();
            
            countdownInterval = setInterval(() => {
                remainingTime--;
                timerText.textContent = formatTime(remainingTime);
                updateTimerCircle();
                
                if (remainingTime % 60 === 0 || (remainingTime < 60 && remainingTime % 10 === 0)) {
                    if (remainingTime !== lastAnnouncement) {
                        announceTimer(`${formatTime(remainingTime)} remaining`);
                        lastAnnouncement = remainingTime;
                    }
                }
                
                if (remainingTime <= 0) {
                    stopTimer();
                    nextSlide();
                }
            }, 1000);
        }
        
        function stopTimer() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
        }
        
        function toggleAutoAdvance() {
            autoAdvanceEnabled = !autoAdvanceEnabled;
            
            if (autoAdvanceEnabled) {
                autoAdvanceToggle.innerHTML = '<span aria-hidden="true">⏸</span> Auto-Advance: ON';
                autoAdvanceToggle.setAttribute('aria-pressed', 'true');
                autoAdvanceToggle.classList.add('active');
                timerContainer.classList.add('active');
                startTimer();
            } else {
                autoAdvanceToggle.innerHTML = '<span aria-hidden="true">▶</span> Auto-Advance: OFF';
                autoAdvanceToggle.setAttribute('aria-pressed', 'false');
                autoAdvanceToggle.classList.remove('active');
                timerContainer.classList.remove('active');
                stopTimer();
            }
        }

        function showSlide(n) {
            slides[currentSlide].classList.remove('active');
            slides[currentSlide].classList.remove('with-header');
            slides[currentSlide].removeAttribute('tabindex');
            
            currentSlide = Math.max(0, Math.min(n, totalSlides - 1));
            slides[currentSlide].classList.add('active');
            
            if (currentSlide === 0) {
                chapterHeader.classList.remove('show');
            } else {
                chapterHeader.classList.add('show');
                slides[currentSlide].classList.add('with-header');
            }
            
            document.getElementById('slideNumber').textContent = currentSlide + 1;
            
            slides[currentSlide].setAttribute('tabindex', '-1');
            slides[currentSlide].focus();
            
            if (autoAdvanceEnabled) {
                startTimer();
            }
        }

        function nextSlide() {
            if (currentSlide < totalSlides - 1) {
                showSlide(currentSlide + 1);
            } else if (CURRENT_CHAPTER_INDEX < CHAPTERS.length - 1) {
                // Boundary: advance to next chapter
                window.location.href = CHAPTERS[CURRENT_CHAPTER_INDEX + 1].file;
            }
        }

        function previousSlide() {
            if (currentSlide > 0) {
                showSlide(currentSlide - 1);
            } else if (CURRENT_CHAPTER_INDEX > 0) {
                // Boundary: go to last slide of previous chapter
                window.location.href = CHAPTERS[CURRENT_CHAPTER_INDEX - 1].file + '?slide=last';
            }
        }

        document.addEventListener('keydown', function(event) {
            // Don't navigate while in dropdown
            if (event.target.closest('.chapter-dropdown-menu')) return;

            const anyDigestOpen = !!document.querySelector('.digest-modal.active');

            if (event.key === 'Escape') {
                if (anyDigestOpen) {
                    closeAllDigests();
                } else {
                    closeDropdown();
                }
                return;
            }

            if (event.key === 'ArrowLeft') {
                if (anyDigestOpen) closeAllDigests();
                previousSlide();
            } else if (event.key === 'ArrowRight') {
                if (anyDigestOpen) closeAllDigests();
                nextSlide();
            } else if (event.key === 'ArrowUp' || event.key === 'ArrowDown') {
                if (anyDigestOpen) {
                    closeAllDigests();
                    return;
                }

                const activeSlide = document.querySelector('.slide.active');
                const digestBtn = activeSlide?.querySelector('.digest-pill[data-digest]');
                const digestId = digestBtn?.getAttribute('data-digest');
                if (digestId) {
                    openDigest(Number(digestId));
                }
            } else if (event.key === 'a' || event.key === 'A') {
                toggleAutoAdvance();
            } else if (event.key === 'd' || event.key === 'D') {
                if (anyDigestOpen) {
                    closeAllDigests();
                    return;
                }

                const activeSlide = document.querySelector('.slide.active');
                const digestBtn = activeSlide?.querySelector('.digest-pill[data-digest]');
                const digestId = digestBtn?.getAttribute('data-digest');
                if (digestId) {
                    openDigest(Number(digestId));
                }
            }
        });

        // ============================================================
        // DEEP LINKING — ?slide=X or ?slide=last
        // ============================================================
        function handleURLParams() {
            const params = new URLSearchParams(window.location.search);
            const sl = params.get('slide');
            if (sl === 'last') {
                showSlide(totalSlides - 1);
                return true;
            } else if (sl) {
                const slideIdx = parseInt(sl) - 1;
                if (slideIdx >= 0 && slideIdx < totalSlides) {
                    showSlide(slideIdx);
                    return true;
                }
            }
            return false;
        }

        // ============================================================
        // INIT
        // ============================================================
        buildDropdown();
        updateChapterNavButtons();
        if (!handleURLParams()) {
            showSlide(0);
        }
    </script>
</body>
</html>
